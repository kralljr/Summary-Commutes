---
title: 'Roadiness: analysis'
author: "Jenna Krall"
date: "10/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, cache = T)
```

```{r}
# libraries
library(tidyverse)
library(knitr)
library(here)
library(lme4)
library(broom.mixed)
library(ggthemes)
library(nlme)
library(forcats)
library(patchwork)
library(RColorBrewer)
# library(lmeInfo)

```


```{r}
# load data
load(here("data/rcomm2.RData"))


# get functions for models
source(here("functions/model-funs.R"))

# load previous results
load(here("data/iqrs.RData"))
load(here("results/main-res.RData"))
base <- res
```

# Sensitivity analysis

```{r adjust}
# Need to remove outliers?
#- Remove PM < 25for models (for normality/skewness)

# remove
shift <- 0.09
rcomm <- filter(rcomm2, PM < 25)  %>% #, PM > 0) 
  mutate(lPM = log(PM + shift),
    cat5sm = fct_relevel(cat5sm, "NW"))


rcomm <- group_by(rcomm, ID, id3) %>%
  arrange(rcomm, timemin) %>%
  ungroup()

# ID 3 is date/commute
rcomm1 <- dplyr::select(rcomm, srness, rtype, id3, PM, daily, 
    obsdiff, ID,date_local, group, awnd , prcpbin , 
    tmax, snowbin, tmin, cat5sm, timemin, lPM) %>% na.omit() 

rcommlag <- dplyr::select(rcomm, srness, rtype, id3, PM, daily, 
    obsdiff, ID,date_local, group, awnd , prcpbin , 
    tmax, snowbin, tmin, cat5sm, timemin, lPM, 
    # lag precip, temp, wind
    prcpbinL1, tmaxL1, tminL1, awndL1, 
    # lead snow
    snowbinL1m) %>% na.omit()
```




```{r}
baseeqn <- "lPM ~ srness + daily + obsdiff + awnd + prcpbin + 
               tmax + snowbin + tmin + rtype + 
               cat5sm"

eqn1 <- "lPM ~ srness + daily + obsdiff + awnd + prcpbin + 
               tmax + snowbinL1m + tmin + rtype + 
               cat5sm"

eqn2 <- "lPM ~ srness + daily + obsdiff + awndL1 + prcpbinL1 + 
               tmaxL1 + snowbin + tminL1 + rtype + 
               cat5sm"

eqn3 <- "lPM ~ srness + daily + obsdiff + awnd + prcpbin + 
               tmax + snowbin + tmin + rtype + 
               cat5sm + timemin"

names <- c("lead snow", "lag meteorol", "timemin", "day-level group", "rand slope")
eqns <- c(eqn1, eqn2, eqn3, rep(baseeqn, 2))
randeff <- c(rep("~ 1| ID / id3", 3), "~ 1 | ID / group / id3", "~ timemin | ID / id3")
ints <- c(T, T, T, F, T)

for(i in 1 : 4) {
  print(names[i])
  if(names[i] %in% c("lead snow", "lag meteorol")) {
    data1 <- rcommlag
  } else {
    data1 <- rcomm1
  }
#     lower  est. upper name 
# * <dbl> <dbl> <dbl> <chr>
# 1 0.404 0.423 0.442 sigma
# 2 0.332 0.578 1.01  ID   
# 3 0.491 0.626 0.797 id3  
  res <- get_lme(data1, iqrs, eqns[i], re = randeff[i], intervals = ints[i]) 
  t1 <- mutate(res$t1, model = names[i])
  re <- mutate(res$re, model = names[i])
  if(i == 1) {
    resall <- full_join(base$t1, t1)
    varcomp <- full_join(base$re, re)

  } else {
    resall <- full_join(resall, t1)
    varcomp <- full_join(varcomp, re)

  }
}



save(resall, varcomp, file = here("results/sens.RData"))
```



## Plot



```{r}
plot_catALL(resall)
```



```{r}
plot_nocatALL(resall)
```






## Variance components



```{r, eval = F}

ggplot(res$re, aes(x = `est.`, y = name)) + 
  geom_pointrange(aes(xmin = lower, xmax = upper )) +
  xlab("Estimate") + ylab("")

```


