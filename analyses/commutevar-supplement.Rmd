---
title: 'Variability in PM2.5 exposures during daily commutes'
subtitle: "Supplementary Material"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, cache = F)
```

```{r}
# libraries
library(tidyverse)
library(knitr)
library(here)
library(viridis)
library(ggthemes)
library(DescTools)
library(RColorBrewer)
library(forcats)
library(lubridate)
library(patchwork)

source(here("rcode/windrose.R"))

# from roadiness-eda.Rmd
load(here("figures/eda-tabfig.RData"))
# from figure2.R
load(here("figures/fighourly.RData"))

# supplement from roadiness-eda.Rmd
load(here("results/supp-plots.RData"))


# gps plot data
load(here("results/gpsplotdata.RData"))

# masstime
load(here("results/masstime.RData"))

# lag figs
load(here("results/lmfig.RData"))


# icc
load(here("results/icc.RData"))

```

# Tables

```{r}
k <- 1
```

## Table S`r k`. Demographic characteristics (N (%)) for N=25 commuters.

```{r}
k <- k + 1
```


```{r}
kable(demo)
```




## Table S`r k`. Meteorological characteristics (N (%)) for N=45 person-days of observation.

```{r}
k <- k + 1
```

```{r}
kable(catweath)
```






## Table S`r k`. Intraclass correlations (ICC) comparing between-participant to within-participant variability by road features, including road types and quartiles of roadiness and speed.

```{r}
k <- k + 1
```

```{r}
kable(icc, digits = 2)
```


# Figures

```{r}
k <- 1
```



## Figure S`r k`. Distributions of in-vehicle PM$_{2.5}$ exposures ($\mu$g/m$^3$) for each participant (N=25) on the natural log scale, along with observation time in minutes.

```{r}
k <- k + 1
```

```{r}
rcomm1 <- boxplot1[[2]]
ns <- boxplot1[[3]]

dates <- dplyr::select(rcomm1, date) %>% unique() %>% 
  rename(date_local = date)
rcomm2 <- rcomm1 %>%
  mutate(PM = PM + 0.01)
figs1 <- ggplot(rcomm2, aes(y = fct_reorder(ID, medl), x  = PM)) + geom_boxplot() +#outlier.shape = NA
   ylab(expression(paste("Minutes observed per participant"))) +
  xlab((expression(paste("PM"[2.5], " (", mu, "g/m"^3, ")")))) +
  scale_x_continuous(trans = "log", breaks = c(0.5, 3, 20)) +
  theme_bw() +
  scale_y_discrete(breaks = ns$ID, labels = ns$n) +
  theme(text = element_text(size = 12))
figs1 

```



## Figure S`r k`. Percentage of observations on each road type per participant (N=25).

```{r}
k <- k + 1
```

```{r}
perc <- roadtype1[[2]]
perc <- mutate(perc, rtype = factor(rtype, levels = c("High/SecHigh", "Other", "LocalConn", "Local"),
                                    labels = c("Highway", "Ramp/Tunnel",
                                               "LocalConn", "Local"))) 

roadtypep <- ggplot(perc, aes(x= rtype, y = fct_inorder(ID), fill= perc)) + 
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red", name = "Percent") +
  xlab("") + ylab("Participant") +
  theme(text = element_text(size=12), axis.text.y = element_blank())

roadtypep

```



## Figure S`r k`. Variation in roadiness (in standard deviations (SD)) and speed (mph) over each observed trip (N=69).  

```{r}
k <- k + 1
```


```{r}
rcomm1 <- tripplot[[2]]
```

```{r}
srness <- ggplot(rcomm1, aes(x = timemin, y = id2, fill = srness)) +
  geom_tile() + ylab("Trip") + xlab("Minutes since trip start") +
  #scale_fill_colorblind(name = "Roadiness") +
 # theme_bw() +
    scale_fill_gradient2(name = "Roadiness", low = "#dedc59", high = "#5c3a85", mid = "white") +
  theme(text = element_text(size=12), axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position  = c(.75, .25))

speed <- ggplot(rcomm1, aes(x = timemin, y = id2, fill = (mph))) +
  geom_tile() + ylab("Trip") + xlab("Minutes since trip start") +
  scale_fill_viridis(begin = 1, end = 0, name = "Speed (mph)") +#(name = "Speed (mph)", high = "#132B43", low = "#56B1F7") +
  #theme_bw() +
  theme(text = element_text(size=12), axis.text.y = element_blank(),
        axis.ticks.y = element_blank(), legend.position = c(.75, .25))

tripplot <- srness + speed
tripplot[[2]] = tripplot[[2]] + theme(axis.text.y = element_blank(),
                                        axis.ticks.y = element_blank(),
                                        axis.title.y = element_blank() )

tripplot

```


## Figure S`r k`. Distributions of daily ambient PM$_{2.5}$ ($\mu$g/m$^3$) and hourly PM$_{2.5}$ ($\mu$g/m$^3$) for N=45 person-days of observation.

```{r}
k <- k + 1
```

```{r}
rcomm1 <- boxplot1[[2]]
ns <- boxplot1[[3]]

dates <- dplyr::select(rcomm1, date, ID) %>% unique() %>% rename(date_local = date)

# get data
va24 <- dailypm[[2]]
va24 <- full_join(va24, dates)


obsdiff0 <- fighourly[[2]]
obsdiff <- left_join(dates, obsdiff0)
alps <- fighourly[[3]] - 0.2
cols <- fighourly[[4]]


# add in median daily PM for hourly
va241 <- dplyr::select(va24, daily) %>% 
  mutate(type = "daily") 
sva <- summarize(va241, med = median(daily))
obsdiff1 <- dplyr::select(obsdiff, time_local, obsdiff) %>%
  mutate(type = "hourly", obsdiff = obsdiff + sva$med,
         type2 = paste0("Hour:", time_local)) %>%
  rename(pm = obsdiff) %>% dplyr::select(-time_local)
va241 <- dplyr::select(va24, daily) %>% 
  mutate(type = "Daily", type2 = "Daily") %>%
  rename(pm = daily)
vals <- c("Daily", paste0("Hour:", seq(0, 23)))
dhour <- bind_rows(obsdiff1, va241) %>%
  mutate(type2 = factor(type2, levels = vals))
```



```{r}
fighourly <- ggplot() +
  geom_boxplot(data = dhour, aes(x = factor(type2), y = pm, colour = type)) +
  geom_vline(xintercept = 1.5, colour = "grey20", linewidth = 1) +
  ylab(expression(paste("PM"[2.5], " (", mu, "g/m"^3, ")"))) +#, #"\nrelative to daily average"))) +
  xlab("") +
  scale_color_manual(values =c(1, cols[1]), guide = "none") +
  theme_bw() +
  theme(text = element_text(size = 12),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
fighourly
```






## Figure S`r k`. Wind rose plot showing direction of the fastest wind (degrees) sustained over five minutes across N=45 person-days of observation.

```{r}
k <- k + 1
```

```{r}
plot.windrose(winddir1)

```




```{r, eval = F}

## Figure S`r k`. GPS locations of all commutes (N=32).

k <- k + 1
```

```{r, eval = F}
t2 <- dplyr::select(rcomm1, ID, cum1, obs, date) %>% unique() 
createcap <- function(x) {
  strsplit(x, " ") %>% 
  lapply(., function(x) paste0(toupper(substr(x, 1, 1)), tolower(substring(x, 2)))) %>% 
     sapply(., function(y) paste(y, collapse = " "))
}


labs1 <- dplyr::select(MainStates1, long, lat, region, subregion) %>%
  group_by(region, subregion) %>% 
  summarize(long = mean(long), lat = mean(lat))
sr1 <- createcap(labs1$subregion)

labs <- labs1 %>%
  ungroup() %>%
  mutate(
         region = case_when(region == "district of columbia" ~"D.C.",
                            region == "maryland" ~"MD",
                            region == "virginia" ~ "VA"),
         subregion = sr1,
         subregion1 = paste0(subregion, ", ", region),
         lat = ifelse(sr1 == "Loudoun", lat - 0.1,
                         ifelse(sr1 == "Prince William", lat - .15,
                                ifelse(sr1 == "Washington", lat + 0.05,
                                       ifelse(sr1 == "Prince Georges",
                                              lat -0.1, 
                                              ifelse(sr1 == "Arlington",
                                                     lat - 0.05, ifelse(sr1 == "Fairfax", lat + 0.05, lat)))))),
         long = ifelse(sr1 == "Arlington", long + .25,
                      ifelse( sr1 == "Fairfax", long - 0.42, 
                              ifelse(sr1 == "Washington", long + 0.2, long))))
g2 <- ggplot() +
  xlim(c(-78, -76.5)) + 
  geom_polygon( data=MainStates1, aes(x=long, y=lat, group = group),
                color="grey70",fill = "white") +
  geom_point(data = t2, aes(x = Longitude, y = Latitude), alpha = 0.05, # prev t1
             colour = "grey40") +
  # scale_color_manual(values = cols) +
  geom_text(data = labs, aes(x = long, y = lat, label = subregion1),
                             colour = "blue") +
  theme(legend.position = "none") +
  xlab("Longitude") + ylab("Latitude") 
g2
```


## Figure S`r k`. Distributions of mass-time ratio of PM$_{2.5}$ by road features, including road types and quartiles of roadiness and speed.  

```{r}
k <- k + 1
```

```{r}
masstime

```



## Figure S`r k`. Associations of road type with in-vehicle PM$_{2.5}$ concentrations from linear mixed models for main models (lag 0) and lags up to 5 minutes, reported as the change in log $\mu$g/m$^3$ comparing travelling on highways, ramps/tunnels, and local connecting roads to local roads.  


```{r}
k <- k + 1
```

```{r}
figs7

```



## Figure S`r k`. Associations of speed and roadiness with in-vehicle PM$_{2.5}$ concentrations from linear mixed models for main models (lag 0) and lags up to 5 minutes, reported as the change in log $\mu$g/m$^3$ for an interquartile (IQR) increase in speed or roadiness.   


```{r}
k <- k + 1
```

```{r}
figs8

```
