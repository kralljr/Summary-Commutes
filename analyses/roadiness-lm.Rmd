---
title: 'Roadiness: analysis'
author: "Jenna Krall"
date: "10/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r}
# libraries
library(tidyverse)
library(knitr)
library(here)
library(lme4)
library(broom.mixed)
library(ggthemes)
library(nlme)
library(forcats)
library(patchwork)
library(RColorBrewer)
# library(lmeInfo)

```


```{r}
# load data
load(here("data/rcomm2.RData"))
```

# Distribution of PM

- Remove PM < 25for models (for normality/skewness)

Percent removed (1. <25, 2. missingness in model ocmponents)

```{r adjust}
# Need to remove outliers?

# remove
shift <- 0.09
rcomm <- filter(rcomm2, PM < 25)  %>% #, PM > 0) 
  mutate(lPM = log(PM + shift),
    cat5sm = fct_relevel(cat5sm, "NW"))

# ID 3 is date/commute
rcomm1 <- dplyr::select(rcomm, srness, rtype, id3, PM, daily, 
    obsdiff, ID,date_local, group, awnd , prcpbin , 
    tmax, snowbin, tmin, cat5sm, timemin, lPM) %>% na.omit() 

iqrs <- dplyr::select(rcomm1, -c(PM, lPM, ID, date_local, group,  
                                prcpbin, snowbin, rtype, id3, cat5sm)) %>%
  pivot_longer(srness : tmin) %>%
  group_by(name)

iqrs <- iqrs %>%
  summarize(IQR = IQR(value)) %>%
  mutate(IQR = ifelse(name %in% c("snowbin", "prcpbin"), 1, IQR)) %>%
  rename(term = name)

# percent removed
((1 - nrow(rcomm) / nrow(rcomm2)) * 100) %>% round(., 1)
((1 - nrow(rcomm1) / nrow(rcomm)) * 100) %>% round(., 1)

```

```{r, eval = F}
# adjusting PM
# rcomm <- mutate(rcomm2, aPM = PM - daily, aPM2 = PM + hourly, aPMall = aPM + hourly,
#                 cat5sm = fct_relevel(cat5sm, "NW"))
# 
# rcomm1 <- dplyr::select(rcomm, ID, rdatetime, rness, PM, aPM : aPMall) %>%
#   pivot_longer(PM : aPMall)

```




```{r hists}

g1 <- ggplot(rcomm1, aes(x = PM)) + geom_histogram(bins = 20) 
g2 <- ggplot(rcomm1, aes(x = PM)) + geom_boxplot() 
g3 <- ggplot(rcomm1, aes(x = lPM)) + geom_histogram(bins =20) 

g4 <- ggplot(rcomm1, aes(x = lPM)) + geom_boxplot() 

(g1 + g2) /( g3 + g4 )
```


```{r}
rcomm1 %>% 
  rename(value = PM) %>%
  summarize(mean = mean(value), sd = sd(value),
            median = median(value), IQR = IQR(value),
            q25 = quantile(value, probs = 0.25), 
            q75 = quantile(value, probs = 0.75),
            min = min(value), max = max(value))
```






# Visualize associations with lPM

```{r}

g1 <- ggplot(rcomm1, aes(x = srness, y = lPM)) +
   geom_point() +geom_smooth() 


g2 <- ggplot(rcomm1, aes(x = daily, y = lPM)) +
   geom_point() +geom_smooth() 


g3 <- ggplot(rcomm1, aes(x = obsdiff, y = lPM)) +
   geom_point() +geom_smooth()  + xlab("Hourly diff")

g4 <- ggplot(rcomm1, aes(x = awnd, y = lPM)) +
   geom_point() +geom_smooth() 

g5 <- ggplot(rcomm1, aes(x = tmax, y = lPM)) +
   geom_point() +geom_smooth() 

g6 <- ggplot(rcomm1, aes(x = tmin, y = lPM)) +
   geom_point() +geom_smooth() 

g7 <- ggplot(rcomm1, aes(x = timemin, y = lPM)) +
   geom_point() +geom_smooth() 

(g1 + g2 + g3 ) / (g4 + g5 + g6 )

g7
```


## Associations with time min

```{r}
rcommU1 <- group_by(rcomm1, id3) %>% mutate(mean = mean(lPM), dPM = lPM - mean)
ggplot(rcommU1, aes(x = timemin, y = dPM, group = id3)) + geom_smooth()

```








# Model







#  Effect plots

```{r}
# Fit AR1 correlation
# groups are big / small


# ID/id3 and ID/id2 are the same: ID/group differs ( does not account for diff trips)
# ID/date/id3, ID/group/id3 are the same, no variation at level 2 (not enough mult trips/day)

# 
rcomm1 <- group_by(rcomm1, ID, id3) %>%
  arrange(rcomm1, timemin) %>%
  ungroup()


cs1 <- corAR1(form = ~1|ID/id3)
cs1 <- Initialize(cs1, data = rcomm1)

# Fit model
lme1 <- lme(lPM ~ srness + daily + obsdiff + awnd + prcpbin + 
               tmax + snowbin + tmin + rtype + 
               cat5sm, 
            random=~1|ID/id3, 
             data=rcomm1, correlation= cs1)

# Get residuals
lme1b <- augment(lme1)

```



## Plot


 
```{r}
t1 <- tidy(lme1, conf.int = T) %>%
  filter(effect == "fixed", term != "(Intercept)") %>%
  full_join(iqrs) %>%
  mutate(IQR = ifelse(is.na(IQR), 1, IQR),
         estimateIQR = estimate * IQR, conf.lowIQR = conf.low * IQR,
         conf.highIQR = conf.high * IQR,
         term1 = factor(term, levels = c("daily", "obsdiff", "srness", "timemin",
                            "rtypeLocalConn",  "rtypeLocal",    "rtypeOther", 
                          "tmax" ,"tmin",  "prcpbin", "snowbin" , "awnd", "cat5smSE", "cat5smOther"),
         labels = c("Daily PM2.5", "Hourly PM2.5", "Roadiness", "Time since start",
                    "Local conn", "Local", "Other",
                    "Max Temp",  "Min Temp", "Precipitation","Snow", "Wind", "WindDir SE", "WindDir Other")),
         type = ifelse(term %in% c("daily", "obsdiff", "srness",   "rtypeLocalConn",  "rtypeLocal",    "rtypeOther", "timemin"), "Pollution", "Meteorology"),
         type2 = ifelse(term %in% c("prcpbin", "snowbin",  "rtypeLocalConn",  "rtypeLocal",    "rtypeOther", "cat5smSE", "cat5smOther"), "cat", "num")) 
```



```{r}

cat<- filter(t1, type2 == "cat") %>%
  mutate(type2 = ifelse(term %in% c("cat5smSE", "cat5smOther"), "Wind direction",
                        ifelse(term %in% c("rtypeOther", "rtypeLocal", "rtypeLocalConn"), "Road type",
                               as.character(term1))),
         term2 = ifelse(term %in% c("cat5smSE","rtypeLocal" ), 2, 
                        ifelse(term %in% c("cat5smOther", "rtypeLocalConn"), 3,
                               ifelse(term == "rtypeOther", 4, 1))), term2 = factor(term2),
         type2 = factor(type2, levels = c("Precipitation", "Snow", "Wind direction", "Road type"))) 

cols <- brewer.pal(8, "Dark2")
g1 <- ggplot(cat, aes(y = term1, x = estimate)) +
  geom_pointrange(aes(xmin = conf.low, xmax = conf.high, colour = term2), 
                  position = position_dodge(0.2)) +
  scale_colour_manual(values = cols,  guide = "none") +
  geom_vline(xintercept = 0, color = "grey50", linetype = 2) +
  xlab("") +
  ylab(expression(paste("Change in PM"[2.5]," (",mu,"g/m"^3, ") compared to reference"))) +
  theme_bw() +
  theme(text = element_text(size = 12)) + facet_wrap(~type2, scales = "free_y", ncol = 1)

g1


# arrange(cat, p.value)
```



```{r}

g2 <- ggplot(filter(t1, type2 != "cat"), aes(y = term1, x = estimateIQR)) +
  geom_pointrange(aes(xmin = conf.lowIQR, xmax = conf.highIQR)) +
  geom_vline(xintercept = 0, color = "grey50", linetype = 2) +
  xlab("") +
  ylab(expression(atop(paste("Change in PM"[2.5]," (",mu,"g/m"^3, ")" ), " per IQR increase"))) +
  theme_bw() +
  theme(text = element_text(size = 24)) 

g2
```


```{r}
arrange(t1, p.value)

arrange(t1, desc(abs(estimate)))
```

## Check residuals



```{r}
ACF(lme1, resType = "normalized", maxLag = 10) %>% plot()

hist(lme1b$.resid)


long <- pivot_longer(lme1b, c(daily, obsdiff, awnd, tmax, tmin, srness, .fitted))
ggplot(long, aes(x = value, y = .resid)) +
  geom_point() +
  facet_wrap(~name, scales = "free")

long <- mutate(lme1b, snowbin = factor(snowbin),
               prcpbin = factor(prcpbin)) %>%
  pivot_longer(c(snowbin, prcpbin, cat5sm, rtype)) 
ggplot(long, aes(x = value, y = .resid)) +
  geom_boxplot() +
  facet_wrap(~name, scales = "free")


```




## Variance components








LME components

- sigma: the estimated within-group error standard deviation (correlation structure): `r lme1$sigma`
- AR correlation: `r lme1$modelStruct$corStruct`
- Model structure:

```{r}
lme1$modelStruct$reStruct

#

# > print(lme1$modelStruct$reStruct)
# Random effects:
#  Formula: ~1 | ID
#         (Intercept)
# StdDev:    1.323336 (DIVIDED BY RESIDUAL)
# 
#  Formula: ~1 | id3 %in% ID
#         (Intercept) Residual
# StdDev:    1.588816        1

# from lme print
# Random effects:
#  Formula: ~1 | ID
#         (Intercept)
# StdDev:   0.5211989
# 
#  Formula: ~1 | id3 %in% ID
#         (Intercept)  Residual
# StdDev:   0.6257585 0.3938522







# WHAT IS THIS?
 # > print(lme1$modelStruct)
# reStruct  parameters:
#       id3        ID 
# 0.4629889 0.2801560 
# corStruct  parameters:
# [1] 0.211365
# 
# sqrt(0.2801560 )
# sqrt(0.4629889)
```



```{r, eval = F}
# lme1$apVar # vcov of variance comp
```

```{r}

# an object inheriting from class lmeStruct, representing a list of mixed-effects model components, such as reStruct, corStruct, and varFunc objects.


# other misc:
# cs1 <- corARMA(form = ~ 1|ID/group, p = 5, q = 5)
# resid <- resid(lme1, type = "normalized")
# VarCorr(lme1d)


# # basically 0
# lme2$coef$random$date_local %>% sd()
# lme3$coef$random$group %>% sd()

```         
    

