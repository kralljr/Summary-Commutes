---
title: 'Roadiness: first analysis'
author: "Jenna Krall"
date: "10/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r}
# libraries
library(tidyverse)
library(knitr)
library(here)
library(lme4)
library(broom.mixed)
library(ggthemes)
library(nlme)

```


```{r}
# load data
load(here("data/rcomm.RData"))
```

# Explore


```{r adjust}
rcomm <- filter(rcomm, PM < 25)
rcomm <- mutate(rcomm, aPM = PM - daily, aPM2 = PM + hourly, aPMall = aPM + hourly)

rcomm1 <- select(rcomm, ID, rdatetime, rness, PM, aPM : aPMall) %>%
  pivot_longer(PM : aPMall)

```


```{r}
ggplot(rcomm1, aes(x = value)) + geom_histogram() +
  facet_wrap(~name)
ggplot(rcomm1, aes(x = value)) + geom_boxplot() +
  facet_wrap(~name)

ggplot(rcomm1, aes(x = log(value + 1))) + geom_boxplot() +
  facet_wrap(~name)

group_by(rcomm1, name) %>% 
  summarize(mean = mean(value), sd = sd(value),
            median = median(value), IQR = IQR(value),
            q25 = quantile(value, probs = 0.25), 
            q75 = quantile(value, probs = 0.75),
            min = min(value), max = max(value))
```

```{r}

ggplot(rcomm1, aes(x = rness, y = value)) +
   geom_point() +geom_smooth() +
  facet_wrap(~name)

```
# Try regression

```{r}
lmer1 <- with(rcomm, lmer(PM ~ rness +  (1 | ID))) %>% tidy(conf.int = T) %>%
  mutate(model = "Unadjusted")

lmer2 <- with(rcomm, lmer(PM ~ rness + daily  + (1 | ID))) %>% tidy(conf.int = T)%>%
  mutate(model = "DailyAdj")


lmer4 <- with(rcomm, lmer(PM ~ rness + daily + hourly  + (1 | ID)))
almer4 <- augment(lmer4)
ggplot(almer4, aes(x = rness, y = .resid)) + geom_point()
ggplot(almer4, aes(x = .resid)) + geom_histogram()


lmer4 <- lmer4 %>% tidy(conf.int = T)%>%
  mutate(model = "HourlyAdj")




lmerd <- with(rcomm, lmer(aPM ~ rness + (1 | ID))) %>% tidy(conf.int = T) %>%
  mutate(model = "DiffDailyAdj")
lmerd2 <- with(rcomm, lmer(aPM2 ~ rness + (1 | ID))) %>% tidy(conf.int = T) %>%
  mutate(model = "DiffTimeAdj")
lmerd3 <- with(rcomm, lmer(aPMall ~ rness + (1 | ID))) %>% tidy(conf.int = T) %>%
  mutate(model = "DiffDTAdj")
# windows?

lmerall <- full_join(lmer1, lmer2) %>%  full_join(., lmer4) %>%
  full_join(., lmerd) %>% full_join(., lmerd2) %>% full_join(., lmerd3) %>%
  filter(term == "rness")
```


```{r, fig.height = 3, fig.width = 4}
ggplot(lmerall, aes(y = model, x = estimate, colour = model)) + 
  geom_pointrange(aes(xmin = conf.low, xmax = conf.high)) +
  scale_color_colorblind() +
  ylab("") + xlab("Change in PM2.5 with increased roadiness") +
  geom_vline(xintercept = 0, linetype =2, colour = "grey50") +
  theme_bw() +
  theme(legend.position = "none")
```





```{r}
# AR1? corARMA?
#rcomm0 <- rcomm
rcomm <- mutate(rcomm, lPM = log(PM),
                mrness = mean(rness), sdrness = sd(rness),
                srness = (rness - mrness) / sdrness) 

rcomm <- group_by(rcomm, ID, date_local, group) %>%
  # start time for each
  mutate(stime = min(rdatetime),
         timemin = as.numeric((rdatetime - stime)/60)) %>%
  filter(!is.na(srness))

# all commutes nested within person only
cs1 <- corAR1(form = ~timemin |ID/id3)
# cs1 <- corARMA(form = ~timemin |ID/id3, p = 1, q = 2)
cs1 <- Initialize(cs1, data = rcomm)

lme1b <- lme(PM ~ srness , random=~timemin|ID/id3, data=rcomm, correlation= cs1)

# explore autocor of residuals
ACF(lme1b, resType = "normalized") %>% plot()


lme0 <- lme(PM ~ srness + daily + obs, random=~1|ID/id3, data=rcomm)

# RE per trip
cs1 <- corAR1(form = ~1| id2)
# cs1 <- corARMA(form = ~ 1|ID/group, p = 5, q = 5)
cs1 <- Initialize(cs1, data = rcomm)

lme1c <- lme(PM ~ srness, random=~1|id2, data=rcomm, correlation= cs1)




cs1 <- corAR1(form = ~1|ID/date_local/group)
# cs1 <- corARMA(form = ~ 1|ID/group, p = 5, q = 5)
cs1 <- Initialize(cs1, data = rcomm)

lme1d <- lme(PM ~ srness, random=~1|ID/date_local/group, data=rcomm, correlation= cs1)


# explore autocor of residuals
ACF(lme0) %>% plot()
AIC(lme1b)

lme1b %>% tidy()

lme1b <- augment(lme1b)


hist(lme1b$.resid)
plot(lme1b$.fitted, lme1b$.resid)
plot(lme1b$srness, lme1b$.resid)


ggplot(lme1b, aes(x = rness, y = .resid, colour = hourly)) + geom_point()
```

# compare lme, nlme
```{r}
lme2 <- lmer(PM ~ rness + (1 | ID) + (1 | ID: group), data = rcomm)
lme2 %>% tidy()

lme1 <- lme(PM ~ rness, random=~1|ID/group, data=rcomm)
lme1 %>% tidy

# fixed effect for ID
lme2 <- lmer(lPM ~ rness + ID +  (1 | ID: group), data = rcomm)
lme2 <- lme2 %>% tidy(conf.int = T)

lme1 <- lme(lPM ~ rness + ID, random=~1|ID/group, data=rcomm)
lme1 <- lme1 %>% tidy(conf.int = T)

lme1 <- mutate(lme1, type = "lme")
lme2 <- mutate(lme2, type = "lmer")
lmeall <- full_join(lme1, lme2)

ggplot(lmeall, aes(x = term, y = estimate, colour = type)) +
  geom_point(position = position_dodge(1)) +
  theme(axis.text.x= element_text(angle = 90, vjust = 0.5, hjust = 1))
```

# check distribution of PM

```{r}
ggplot(rcomm, aes(y = PM, x = rness, colour = ID)) + geom_point()
ggplot(rcomm, aes(y = log(PM + 0.2), x = ID, colour = ID)) + geom_violin() +
  theme(legend.position = "none")
```
