---
title: 'Roadiness: analysis'
author: "Jenna Krall"
date: "10/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r}
# libraries
library(tidyverse)
library(knitr)
library(here)
library(lme4)
library(broom.mixed)
library(ggthemes)
library(nlme)
library(forcats)
library(patchwork)
library(RColorBrewer)
# library(lmeInfo)

```


```{r}
# load data
load(here("data/rcomm2.RData"))


# load iqrs
load(here("data/iqrs.RData"))

# get functions for models
source(here("functions/model-funs.R"))



```

# Distribution of PM


Meteorology:
- Lag 1: max temp, min temp, wind speed, precipitation
- Lead snow


```{r}
rcomm1 <- rcommLM
```




```{r hists}

g1 <- ggplot(rcomm1, aes(x = PM)) + geom_histogram(bins = 20) 
g2 <- ggplot(rcomm1, aes(x = PM)) + geom_boxplot() 
g3 <- ggplot(rcomm1, aes(x = lPM)) + geom_histogram(bins =20) 

g4 <- ggplot(rcomm1, aes(x = lPM)) + geom_boxplot() 

(g1 + g2) /( g3 + g4 )
```


```{r}
rcomm1 %>% 
  rename(value = PM) %>%
  summarize(mean = mean(value), sd = sd(value),
            median = median(value), IQR = IQR(value),
            q25 = quantile(value, probs = 0.25), 
            q75 = quantile(value, probs = 0.75),
            min = min(value), max = max(value))
```






# Visualize associations with lPM

```{r}

g1 <- ggplot(rcomm1, aes(x = srness, y = lPM)) +
   geom_point() +geom_smooth() 


g2 <- ggplot(rcomm1, aes(x = daily, y = lPM)) +
   geom_point() +geom_smooth() 


g3 <- ggplot(rcomm1, aes(x = obsdiff, y = lPM)) +
   geom_point() +geom_smooth()  + xlab("Hourly diff")

g4 <- ggplot(rcomm1, aes(x = awnd, y = lPM)) +
   geom_point() +geom_smooth() 

g5 <- ggplot(rcomm1, aes(x = tmax, y = lPM)) +
   geom_point() +geom_smooth() 

g6 <- ggplot(rcomm1, aes(x = tmin, y = lPM)) +
   geom_point() +geom_smooth() 

g7 <- ggplot(rcomm1, aes(x = timemin, y = lPM)) +
   geom_point() +geom_smooth() 

(g1 + g2 + g3 ) / (g4 + g5 + g6 ) 

g7
```


## Associations with time min

```{r}
rcommU1 <- group_by(rcomm1, id3) %>% mutate(mean = mean(lPM), dPM = lPM - mean)
ggplot(rcommU1, aes(x = timemin, y = dPM, group = id3)) + geom_smooth()

```








# Model


```{r}
# Fit AR1 correlation
# groups are big / small


# ID/id3 and ID/id2 are the same: ID/group differs ( does not account for diff trips)
# ID/date/id3, ID/group/id3 are the same, no variation at level 2 (not enough mult trips/day)

# 
rcomm1 <- group_by(rcomm1, ID, id3) %>%
  arrange(rcomm1, timemin) %>%
  ungroup()
```


## Roadiness 

```{r}
eqn1 <- "lPM ~ srness"
res1 <- get_lme(rcomm1, iqrs, eqn1, re = "~ 1| ID / id3")
res1rn <- res1

eqn2 <- "lPM ~ srness + awnd + prcpbin + 
               tmax  + tmin +  RH + 
               cat5sm + snowbin" 
res2 <- get_lme(rcomm1, iqrs, eqn2, re = "~ 1| ID / id3")


eqn3 <- "lPM ~ srness + daily + obsdiff" 
res3 <- get_lme(rcomm1, iqrs, eqn3, re = "~ 1| ID / id3")

resl <- list(Main = res1, Weather = res2, PM = res3)
plot_nocat_sens(resl, "srness")

```


## Road type 

```{r}
eqn1 <- "lPM ~ rtype"
res1 <- get_lme(rcomm1, iqrs, eqn1, re = "~ 1| ID / id3")
res1rt <- res1

eqn2 <- "lPM ~ rtype + awnd + prcpbin + 
               tmax  + tmin +  RH + 
               cat5sm + snowbin" 
res2 <- get_lme(rcomm1, iqrs, eqn2, re = "~ 1| ID / id3")


eqn3 <- "lPM ~ rtype + daily + obsdiff" 
res3 <- get_lme(rcomm1, iqrs, eqn3, re = "~ 1| ID / id3")

resl <- list(Main = res1, Weather = res2, PM = res3)
plot_cat_sens(resl, "rtype")

```


## Speed

```{r}


```

## Traffic




## All

```{r}
eqnA <- "lPM ~ srness + rtype"
resA <- get_lme(rcomm1, iqrs, eqnA, re = "~ 1| ID / id3") 

# still autocorr
ACF(resA$lme1, resType = "normalized", maxLag = 10) %>% plot()
lme1b <- resA$aug
hist(lme1b$.resid)


long <- pivot_longer(lme1b, c(daily, obsdiff, awnd, tmax, tmin, srness, .fitted)) %>%
  filter(name %in% "srness")
ggplot(long, aes(x = value, y = .resid)) +
  geom_point() +
  facet_wrap(~name, scales = "free")


long <- mutate(lme1b, #snowbin = factor(snowbin),
               prcpbin = factor(prcpbin)) %>%
  pivot_longer(c(prcpbin, cat5sm, rtype))  %>% #snowbin, 
  filter(name %in% "rtype")
ggplot(long, aes(x = value, y = .resid)) +
  geom_boxplot() +
  facet_wrap(~name, scales = "free")

```


```{r}
resl <- list(Main = res1rt, All = resA)
plot_cat_sens(resl, "rtype")
```

```{r}

resl <- list(Main = res1rn, All = resA)
plot_nocat_sens(resl, "srness")
```




```{r}
# Get residuals
save(resA, res1rn, res1rt, file = here("results/main-res.RData"))
```











# Misc


## Weather


```{r}
eqn1 <- "lPM ~  awnd + prcpbin + 
               tmax  + tmin +  RH + 
               cat5sm + snowbin"
res <- get_lme(rcomm1, iqrs, eqn1, re = "~ 1| ID / id3") 

plot_cat(res)

```


## Ambient daily and hourly PM

```{r}
eqn1 <- "lPM ~ daily + obsdiff"
res <- get_lme(rcomm1, iqrs, eqn1, re = "~ 1| ID / id3") 

plot_nocat(res)

```
