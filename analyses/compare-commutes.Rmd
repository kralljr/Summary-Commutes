---
title: 'Compare commutes'
author: "Jenna Krall"
date: "1/7/2021"
output: html_document
---






```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, cache = T)
```

```{r}
# libraries
library(dplyr)

library(tidyverse)
library(knitr)
library(here)
library(ggthemes)
library(RColorBrewer)
library(forcats)
library(lubridate)

library( sf)
library( data.table)
library( viridis)
# add here to fixfile path
# need raster package
library(raster)

library(dplyr)

```


```{r}
# load data
load(here("data/comparedat.RData"))
```


# Table of paired  

- Diff is difference in commute length (minutes)
- Diffhour is difference in when commute started (minutes)
```{r}

compare1 <- ungroup(compare) %>%
  dplyr::select(ID, commute, date1, maxtime) %>% unique() %>%
  pivot_wider(names_from = "date1", values_from = "maxtime") %>%
  mutate(diff = day1 - day2, diff = as.numeric(diff)) %>%
  arrange(abs(diff))


hours <- ungroup(compare) %>%
  dplyr::select(ID, commute, date1, min) %>% unique() %>%
  pivot_wider(names_from = "date1", values_from = "min") %>%
  mutate(diffhour = difftime(day2, day1, units = "mins"), diffhour = ifelse(ID != "GMU1018", as.numeric(diffhour) - 24 * 60,  as.numeric(diffhour) - 24*2 * 60)) %>%
  dplyr::select(ID, commute, diffhour)

compare1 <- full_join(compare1, hours)

# six with close times, six with different
# filter(compare1, abs(diff) < 5)

compare2 <- ungroup(compare1) %>% arrange(ID, commute)
kable(compare2)


```


**Total lat/lon observations**

```{r}
ungroup(compare) %>%
  dplyr::select(ID, commute, date1, maxtime) %>% unique() %>%
  summarize(n = as.numeric(sum(maxtime))) %>%
  # count minute 0 obs, subtract 4 missing minutes
  mutate(n = n + 24, n = n- 4)

```



```{r, eval = F}
# check weird number of obs

ungroup(compare) %>% dplyr::select(ID, commute, date1, maxtime) %>%
  unique() %>%
  summarize(sum(maxtime))

try0 <- ungroup(compare) %>% dplyr::select(ID, commute, date1, rdatetime, min) %>%
  unique() %>% mutate(diff = as.numeric(rdatetime - min)) %>%
  group_by(ID, min) %>%
  summarize(max = max(diff), max = max / 60) %>%
  ungroup() 

try0 %>%
  summarize(s1 = sum(max)) 

c1 <- ungroup(compare) %>% dplyr::select(ID, commute, date1, rdatetime, min) %>%
  unique()
nrow(c1)


try1 <- group_by(c1, ID, min) %>% count(min) %>% ungroup() %>% rename(n2 = n)
summarize(try1,  n2 = sum(n2))

check40 <- full_join(try0, try1) %>%
  mutate(diff = n2 - max) %>% filter(diff != 1)
check40
check40 <- check40 %>%
  dplyr::select(min)

# gap in obs: 4 minutes missing (8:57, 58, 59, 00)
filter(c1, ID == "GMU1040", min == check40$min) %>% View()

# 24: 0 minute obs
ungroup(compare) %>% dplyr::select(ID, commute, date1, rdatetime, min) %>%
  unique() %>% mutate(diff = as.numeric(rdatetime - min)) %>%
  filter(diff == 0)

```

**Differences between commute start time**

```{r}
mutate(compare1, absdiff = abs(diffhour)) %>%
  summarize(mean(absdiff), median(absdiff), min(absdiff), max(absdiff)) %>%
  kable()
```

**Differences between commute length**

```{r}
mutate(compare1, absdiff = abs(diff)) %>%
  summarize(mean(absdiff), median(absdiff), min(absdiff), max(absdiff)) %>%
  kable()

```



# PM data



## Distributions

```{r}

ggplot(comparepm, aes(x = PM, y= ..density.., fill = date1)) + geom_histogram(bins = 15) +
  facet_wrap(ID ~ commute, scales ="free")


ggplot(comparepm, aes(x = date1, y = lPM)) + geom_boxplot() +
  facet_wrap(ID ~ commute, scales= "free")


```

Note: GMU1001 on the right had a 0 value (hence very negative/apparent difference here not found in subsequent plot)

## Summary 


```{r}

s1 <- group_by(comparepm, ID, date1, commute) %>%
  summarize(mean = mean(lPM), sd1 = sd(lPM), n = n()) %>%
  mutate(se = sd1 / sqrt(n), lb = mean - 1.96 * se, ub = mean + 1.96 * se,
         id = paste0(ID, commute)) %>% ungroup() %>%
  group_by(ID, commute) %>%
         mutate(minmean = min(mean),day = ifelse(mean == minmean, "Obs1", "Obs2")) 

ggplot(s1, aes(x = fct_reorder(id, minmean), y = mean))  + 
  geom_pointrange(aes(ymin = lb, ymax = ub, colour = day)) +
  ylab("mean log PM2.5") + xlab("Commute") +
  theme(axis.text.x = element_blank())
```


### median by day

```{r}

s1b <- group_by(comparepm, ID, date1, commute) %>%
  mutate(adpmd = PM / daily) %>%
  summarize(median = median(adpmd), Q1 = quantile(adpmd, probs = 0.25),
            Q3 = quantile(adpmd, probs = 0.75)) %>% ungroup() %>%
  mutate( id = paste0(ID, commute)) %>% ungroup() 



ggplot(s1b, aes(x = id, y = median, colour = date1))  + 
  geom_pointrange(aes(ymin = Q1, ymax = Q3), position= position_dodge(0.4)) +
  theme_bw() +
    theme(axis.text.x = element_blank())
```

Differences between day1 and day2

```{r}
mutate(s1b, diff = abs(day1 - day2)) %>%
  summarize(median(diff), mean(diff), min(diff), max(diff))
  

pairedpoint <- ggplot(s1b, aes(x = day1, y = day2)) + geom_point() + geom_abline(slope = 1, intercept = 0, linetype = 2) + ylim(0, 18) + 
  xlab(expression(paste("Observation 1 median PM"[2.5], " (", mu, "g/m"^3, ")"))) + 
  ylab(expression(paste("Observation 2 median PM"[2.5], " (", mu, "g/m"^3, ")"))) + 
  theme_bw() +
  theme(text = element_text(size = 12))
pairedpoint <- list(pairedpoint, s1b)
```


## Time since commute

```{r}

ggplot(comparepm, aes(x = time, y = PM, colour = date1)) + geom_point(alpha = 0.2) +
  geom_smooth() +
    facet_wrap(ID ~ commute, scales= "free")

```




## Proportion of commute
```{r}


ggplot(comparepm, aes(x = proptime, y = PM, colour = date1)) +geom_point(alpha = 0.2) +
  geom_smooth() +
    facet_wrap(ID ~ commute, scales= "free")
```

### adjust for daily

```{r}
ggplot(comparepm, aes(x = proptime, y = adpmd, colour = date1)) + geom_point(alpha = 0.2) +
  geom_smooth() +
    facet_wrap(ID ~ commute, scales= "free")
```

## Adjust for day

Doesn't seem like day explains.  Day shown in red

```{r}

cva24 <- dplyr::select(comparepm, ID, date, daily, commute, date1) %>% unique() %>%
  mutate(ldaily = log(daily + 0.01))

ggplot() + geom_boxplot(data =comparepm, aes(x = date1, y = lPM)) +
  geom_point(data = cva24, aes(x = date1, y = ldaily), colour = "red") +
  facet_wrap(ID ~ commute, scales= "free")

```




## Adjust for hour

```{r}

ggplot(comparepm, aes(x = proptime, y = ahour, colour = date1)) + geom_point(alpha = 0.2) +
  geom_smooth() +
    facet_wrap(ID ~ commute, scales= "free")


```

# Differences

```{r}
# time of day, length of commute, temp/weather?
s1 <- group_by(comparepm, ID, date1, commute) %>% summarize(mean = mean(lPM), daily = mean(daily), ) %>%
  ungroup() %>%
  mutate(adjust = mean - daily)
ggplot(s1, aes(x = mean ))+ geom_histogram(bins = 10) + facet_wrap( ~ date1)

s1 <- dplyr::select(s1, -c(mean, daily)) %>% 
  pivot_wider(names_from = "date1", values_from = "adjust") %>%
  mutate(diff = (day1 - day2))

t.test(s1$diff)

ggplot(s1, aes(x = diff)) + geom_histogram(bins = 10)


filter(s1b, day1 > 5 | day2 > 5)

# color by diff in 24 hour PM2.5
# 37 much longer on day1 (4:30 vs. 3:45 commute time), maybe different overall commute
# cumulative PM over commute adjusted for commute length
```


