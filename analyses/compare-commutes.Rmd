---
title: 'Compare commutes'
author: "Jenna Krall"
date: "1/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, cache = T)
```

```{r}
# libraries
library(dplyr)

library(tidyverse)
library(knitr)
library(here)
library(ggthemes)
library(RColorBrewer)
library(forcats)
library(lubridate)

library( sf)
library( data.table)
library( viridis)
# add here to fixfile path
# need raster package
library(raster)

library(dplyr)

```


```{r}
# load data
load(here("data/rcomm2.RData"))
load(here("data/gpslatlon.RData"))
load(here("data/MainStates1.RData"))
```


```{r plotfun}


g2 <- function(dat) {
  xs <- c(min(dat$Longitude), max(dat$Longitude))
  ys <- c(min(dat$Latitude), max(dat$Latitude))
  ggplot() +
  geom_polygon( data=MainStates1, aes(x=long, y=lat, group = group),
                color="grey50",fill = "white") +
  geom_point(data = dat, aes(x = Longitude, y = Latitude, colour = min), alpha = 0.2) +
    scale_color_manual(values = cols) + 
    xlim(xs) + ylim(ys) +
  theme(legend.position = "none") +
  xlab("Longitude") + ylab("Latitude") + theme_bw()
}

cols <- brewer.pal(8, "Dark2")


```

# Get data

```{r}
# find IDs from first plot (explore)
ids <- paste0("GMU10", c("01", "07", 16, 18, 32, 35, 36, 37, 40, 45))

# restrict to these IDs
rcomm2 <- filter(rcomm2, ID %in% ids) %>%
  # format date/times
  mutate(dt1 = lubridate::date(rdatetime), 
                dt2 =  lubridate::as_datetime(dt1),
                dt2= lubridate::force_tz(dt2, "America/New_York"),
                diff1 = rdatetime - dt2, diff1 = diff1 / 60 / 60)


# GPS data
dat <- gpslatlon$dat %>% 
  # Get date/time for GPS
  mutate(rdatetime = dmy_hms(`Date & Time`)) %>%
  dplyr::select(1, c(3 : 4), rdatetime) %>%
  filter(Latitude != 0)

# Find unique commutes by time
rc1 <- dplyr::select(rcomm2, rdatetime, ID, date_local, group) %>%
  arrange(ID, date_local, group) %>%
  group_by(ID, date_local, group) %>%
  mutate(min = min(rdatetime)) %>% ungroup()

# number of obs
rows <- rc1 %>%
  dplyr::group_by(ID) %>%
  dplyr::select(ID, date_local, group) %>%
  unique() %>%
  mutate(rows = row_number())

# combine
rc1 <- full_join(rc1, rows)

# join GPS and commute
join1 <- left_join(rc1, dat) %>% na.omit()

```



# Morning commutes


```{r}
morning <- filter(rcomm2, hour(rdatetime) < 11)
# morning only
# 1, 7, 16, 18 (3?), 

ggplot(morning, aes(x = diff1, y = date_local, fill = rtype)) +
  geom_tile() +
  facet_wrap(~ID, ncol = 3, scales = "free_y")

```






## Map all

- 7 morning commutes

- 32 only in evening
- 35: 2 directions
- 36: Different destination/no overlap
 
```{r, fig.height=3}


# restrict to same morning commutes
jmorning <- filter(join1, hour(rdatetime) < 11,
                !(ID == "GMU1007" & Longitude > -77.315),
                !(ID == "GMU1016" & Longitude > -77.25),
                !(ID == "GMU1018" & min == "2018-11-07 09:28:00"),
                !(ID == "GMU1037" & Longitude < -77.305),
                 !(ID == "GMU1040" & (Longitude < -77.28)),
                !(ID == "GMU1045" & (Longitude < -77.21)),
                !(ID %in% c("GMU1032", "GMU1035", "GMU1036"))) %>%
  mutate(min = as.character(min), 
          min = ifelse(ID == "GMU1040" & min == "2019-02-13 09:01:00", "2019-02-13 08:43:00", min), commute = "morning")

## 35 looks like 2 different ways?
# 32 only one morning commute
# 36no overlap

unid <- unique(jmorning$ID)
for(i in seq_along(unid)) {
  
  print(unid[i])
  
  print(g2(filter(jmorning, ID == unid[i])))
}

```




# Evening commutes

- 5 commutes


```{r}
evening <- filter(rcomm2, hour(rdatetime) >12, ID %in% paste0("GMU10", c("01", 32, 36, 37, 40)))

ggplot(evening, aes(x = diff1, y = date_local, fill = rtype)) +
  geom_tile() +
  facet_wrap(~ID, ncol = 3, scales = "free_y")

```






## Map all


```{r, fig.height=3}


# restrict to same evening commutes
jevening <- filter(join1, hour(rdatetime) > 12, ID %in% paste0("GMU10", c("01", 32, 36, 37, 40)),
               !(ID == "GMU1001" & min == "2018-05-08 18:44:00"),
                  !(ID == "GMU1032" & Latitude > 38.69),
                 !(ID == "GMU1036" & Longitude > -77.24),
                !(ID == "GMU1037" & min == "2019-02-05 22:08:00"),
                !(ID == "GMU1037" & (Longitude < -77.27 | Latitude > 38.92 | Latitude < 38.877)),
               !(ID == "GMU1040" & (Longitude < -77.28 | Longitude >-77.20))) %>%
  
   mutate(min = as.character(min), commute = "evening")
unid <- unique(jevening$ID)
for(i in seq_along(unid)) {
  
  print(unid[i])
  
  print(g2(filter(jevening, ID == unid[i])))
}

```


# Commute compare

- Diff is difference in commute length (minutes)
- Diffhour is difference in when commute started (minutes)
```{r}
compare <- full_join(jmorning, jevening) %>%
  mutate(date = date(rdatetime)) %>%
  group_by(ID, date, commute) %>%
  # get time since commute start
  mutate(min = min(rdatetime),
         time = difftime(rdatetime, min, units= "mins"), maxtime = max(time)) %>%
  ungroup() %>% group_by(ID, commute) %>%
         mutate(mindate = min(date(rdatetime)), date1 = ifelse(date(rdatetime) == mindate, "day1", "day2"))


compare1 <- ungroup(compare) %>%
  dplyr::select(ID, commute, date1, maxtime) %>% unique() %>%
  pivot_wider(names_from = "date1", values_from = "maxtime") %>%
  mutate(diff = day1 - day2, diff = as.numeric(diff)) %>%
  arrange(abs(diff))


hours <- ungroup(compare) %>%
  dplyr::select(ID, commute, date1, min) %>% unique() %>%
  pivot_wider(names_from = "date1", values_from = "min") %>%
  mutate(diffhour = difftime(day2, day1, units = "mins"), diffhour = ifelse(ID != "GMU1018", as.numeric(diffhour) - 24 * 60,  as.numeric(diffhour) - 24*2 * 60)) %>%
  dplyr::select(ID, commute, diffhour)

compare1 <- full_join(compare1, hours)

# six with close times, six with different
# filter(compare1, abs(diff) < 5)

kable(compare1)




```



# PM data

```{r}
load(here("data/pm-cleaned.RData"))
load(here("data/va24.RData"))
load(here("data/vah.RData"))


pm1 <- dplyr::select(pm1, rdatetime, PM, ID) %>% unique() %>%
                mutate(  lPM = log(PM + 0.01))


comparepm <- left_join(compare, pm1) %>%
  mutate(time_local = hour(rdatetime),
         time_local = ifelse(time_local == 24, 0, time_local)) %>%
  left_join(va24) %>%
  left_join(vah0) %>%
  ungroup() %>%
  group_by(ID, date, commute) %>%
  mutate( time = as.numeric(time),maxtime = max(time),
         proptime = time / maxtime, adpmd = PM - daily, ahour = PM + obsdiff )
```


## Distributions

```{r}

ggplot(comparepm, aes(x = PM, y= ..density.., fill = date1)) + geom_histogram(bins = 15) +
  facet_wrap(ID ~ commute, scales ="free")


ggplot(comparepm, aes(x = date1, y = lPM)) + geom_boxplot() +
  facet_wrap(ID ~ commute, scales= "free")

s1 <- group_by(comparepm, ID, date1, commute) %>%
  summarize(mean = mean(lPM), sd1 = sd(lPM), n = n()) %>%
  mutate(se = sd1 / sqrt(n), lb = mean - 1.96 * se, ub = mean + 1.96 * se,
         id = paste0(ID, commute)) %>% ungroup() %>%
  group_by(ID, commute) %>%
         mutate(minmean = min(mean),day = ifelse(mean == minmean, "Obs1", "Obs2")) 
```

Note: GMU1001 on the right had a 0 value (hence very negative/apparent difference here not found in subsequent plot)
```{r}
ggplot(s1, aes(x = fct_reorder(id, minmean), y = mean))  + 
  geom_pointrange(aes(ymin = lb, ymax = ub, colour = day)) +
  ylab("log PM2.5") + xlab("Commute") +
  theme(axis.text.x = element_blank())
```



```{r}
s1b <- group_by(comparepm, ID, date1, commute) %>%
  summarize(mean = median(PM), sd1 = sd(lPM), n = n()) %>%
  mutate(se = sd1 / sqrt(n), lb = mean - 1.96 * se, ub = mean + 1.96 * se,
         id = paste0(ID, commute)) %>% ungroup() %>%
  group_by(ID, commute) %>%
         mutate(minmean = min(mean),day = ifelse(mean == minmean, "Obs1", "Obs2")) %>% ungroup() %>% dplyr::select(ID, date1, commute, mean) %>%
  pivot_wider(names_from = "date1", values_from = "mean")
ggplot(s1b, aes(x = day1, y = day2)) + geom_point() + geom_abline(slope = 1, intercept = 0, linetype = 2) + ylim(0, 18) + xlab("Observation 1 median PM2.5") + ylab("Observation 2 median PM2.5")
```


## Time since commute
```{r}

ggplot(comparepm, aes(x = time, y = PM, colour = date1)) + geom_point(alpha = 0.2) +
  geom_smooth() +
    facet_wrap(ID ~ commute, scales= "free")

```




## Proportion of commute
```{r}


ggplot(comparepm, aes(x = proptime, y = PM, colour = date1)) +geom_point(alpha = 0.2) +
  geom_smooth() +
    facet_wrap(ID ~ commute, scales= "free")

ggplot(comparepm, aes(x = proptime, y = adpmd, colour = date1)) + geom_point(alpha = 0.2) +
  geom_smooth() +
    facet_wrap(ID ~ commute, scales= "free")
```

## Adjust for day

Doesn't seem like day explains

```{r}

cva24 <- dplyr::select(comparepm, ID, date, daily, commute, date1) %>% unique() %>%
  mutate(ldaily = log(daily + 0.01))

ggplot() + geom_boxplot(data =comparepm, aes(x = date1, y = lPM)) +
  geom_point(data = cva24, aes(x = date1, y = ldaily, colour = "red")) +
  facet_wrap(ID ~ commute, scales= "free")

```




## Adjust for hour

```{r}

ggplot(comparepm, aes(x = proptime, y = ahour, colour = date1)) + geom_point(alpha = 0.2) +
  geom_smooth() +
    facet_wrap(ID ~ commute, scales= "free")


```

# Differences

```{r}
# time of day, length of commute, temp/weather?
s1 <- group_by(comparepm, ID, date1, commute) %>% summarize(mean = mean(lPM), daily = mean(daily), ) %>%
  ungroup() %>%
  mutate(adjust = mean - daily)
ggplot(s1, aes(x = mean ))+ geom_histogram(bins = 10) + facet_wrap( ~ date1)

s1 <- dplyr::select(s1, -c(mean, daily)) %>% 
  pivot_wider(names_from = "date1", values_from = "adjust") %>%
  mutate(diff = (day1 - day2))

t.test(s1$diff)

ggplot(s1, aes(x = diff)) + geom_histogram(bins = 10)


filter(s1b, day1 > 5 | day2 > 5)

# color by diff in 24 hour PM2.5
# 37 much longer on day1 (4:30 vs. 3:45 commute time), maybe different overall commute
# cumulative PM over commute adjusted for commute length
```
