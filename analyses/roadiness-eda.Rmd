---
title: 'Roadiness: EDA'
author: "Jenna Krall"
date: "1/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, cache = T)
```

```{r}
# libraries
library(tidyverse)
library(knitr)
library(here)
library(ggthemes)
library(DescTools)
library(RColorBrewer)
library(forcats)
library(lubridate)
library(patchwork)


source(here("rcode/windrose.R"))

```


```{r}
# load data
load(here("data/rcomm2.RData"))
rcomm <- rcomm2 

load(here("data/va24.RData"))

```

# Data summary

- Our data contains 2311 observations for 25 commuters and 69 commutes.  
- 38 days of data
- 45 person-days
- The number of minutes of total commuting time observed per commuter ranged from 24 to 267 with a median of 54 minutes.  
- We observed 1 commute for 10 commuters (40%).  We observed 2-4 commutes for 9 commuters (36%) and 5-6 commutes for 6 commuters (24%). 



```{r, echo = T}
# total observations
nrow(rcomm)

# total commuters
unique(rcomm$ID) %>% length()

# total commutes
select(rcomm, ID, date_local, group) %>% unique() %>% nrow()

# person-days
select(rcomm, ID, date_local) %>% unique() %>% nrow()

# days
select(rcomm, date_local) %>% unique() %>% nrow()

# total minutes of obs per commuter
g1 <- group_by(rcomm, ID) %>% summarize(n=n()) %>% ungroup() %>% arrange(n)
g1 %>%
  kable()


# summary of total minutes of obs per commuter
summarize(g1, min(n), max(n), median(n), mean(n))

# commutes per commuter
select(rcomm, ID, date_local, group) %>% unique() %>% group_by(ID) %>% count() %>%
  ungroup() %>% rename(commutesobs= n) %>% count(commutesobs) %>% 
  mutate(perc = round(100 * n/sum(n), 1)) %>% kable()
```


The average commute length observed was approximately 30 minutes with commutes ranging from 15 to 99 minutes.

```{r}
# # length of time per commute
group_by(rcomm, ID, date_local, group) %>% count() %>% ungroup() %>%
  summarize(min = min(n), max = max(n))

# length of time per commute by ID
g1 <- group_by(rcomm, ID, date_local, group) %>% summarize(n = n()) %>%
  ungroup() %>% group_by(ID) %>% summarize(mean = mean(n), min = min(n), max = max(n), median = median(n)) %>% ungroup()

g1 %>%
  kable()

# average length of time per commute
g1 %>% summarize(mean(median), median(mean), mean(mean), median(median))
```



# PM

## Number of zeroes

```{r}
filter(rcomm, PM == 0) %>% count(ID) %>% filter(n > 0)
```

## Histogram of PM

```{r}
ggplot(rcomm, aes(x = PM)) + geom_histogram()

```

## Histogram of PM by ID

```{r, fig.height = 20}
ggplot(rcomm, aes(x = PM)) + geom_histogram(bins = 15) + 
  facet_wrap(~ID, scales ="free", ncol = 3)

```

## Histogram of log(PM + 0.01) by ID


```{r, fig.height = 20}
ggplot(rcomm, aes(x = lPM)) + geom_histogram(bins = 15) + 
  facet_wrap(~ID, scales ="free", ncol = 3)

```

## Summarize


### By ID 

```{r}

sum1 <- group_by(rcomm, ID) %>% summarize(lmean = mean(lPM), 
      lsd = sd(lPM), lmin = min(lPM), lmax = max(lPM),
      mean = mean(PM), 
      sd = sd(PM), min = min(PM), max = max(PM)) %>%ungroup()

sum1%>%
  kable(digits = 2)
```

### Across IDs

The average minute PM2.5 across participants was 5.5 mug/m3 ranging from 0 to 50.2 mug/m3.  In general, there was greater variability between participants than within a participant over the commutes, though variability was great for some participants.

```{r}
select(sum1, ID, lmean, mean,sd) %>% pivot_longer(-ID) %>%
  group_by(name) %>% summarize(med = median(value), mean = mean(value), sd = sd(value)) %>%
  kable(digits =2)


select(sum1, ID, min, max) %>%  summarize(min = min(min), max = max(max))
```

## Violin plots

```{r}
ggplot(rcomm, aes(y = ID, x  = lPM)) + geom_violin()
```



## Box plots

```{r}
rcomm1 <- group_by(rcomm, ID) %>% mutate(medl = median(lPM, na.rm = T), n = n()) %>%
  ungroup()
rcomm1 <- arrange(rcomm1, medl)
ns <- select(rcomm1, ID, medl, n) %>% unique()
boxplot1 <- ggplot(rcomm1, aes(y = fct_reorder(ID, medl), x  = lPM)) + geom_boxplot() +#outlier.shape = NA
   ylab(expression(paste("Minutes observed per participant"))) +
  xlab((expression(paste("log PM"[2.5], " (log ", mu, "g/m"^3, ")")))) +
  theme_bw() +
  scale_y_discrete(breaks = ns$ID, labels = ns$n) +
  theme(text = element_text(size = 12))
boxplot1 

boxplot1 <- list(boxplot1, rcomm1, ns)



```


## Commute summaries

### Mean by commute

```{r}
sumdat <- group_by(rcomm, ID, date_local, group) %>%
  summarize(meanPM= mean(lPM), sdPM = sd(lPM))

cols <- brewer.pal(8, "Dark2")
cols <- rep(cols, 4)
ggplot(sumdat, aes(x = meanPM, y = ID, colour = ID)) +
  geom_point(alpha = 0.7) +
  scale_color_manual(values = cols, guide = "none") +
  theme_bw()
```

### SD by commute

```{r}
# 1 observation only
ggplot(sumdat, aes(x = sdPM, y = ID, colour = ID)) +
  geom_point(alpha = 0.7) +
  scale_color_manual(values = cols, guide = "none") +
  theme_bw()
```


# Roadiness/Road type


2. Possible misclassification 

Most observations (N=1215, 52.6%) were for local roads.  600 observations (26%) were on highways and 399 (17.3%) were on local connecting roads which are XX.  The remainder (N=97, 4.2%) were on ramps, tunnels, or others.

```{r}
count(rcomm, rtype) %>%
  mutate(perc = n / sum(n) * 100, perc = round(perc, 1)) 


perc <- group_by(rcomm, ID) %>%
  count(rtype) %>%
  mutate(perc = n / sum(n) * 100, perc = round(perc, 1),
         rtype = factor(rtype, levels = c("Local", "LocalConn",
                                          "High/SecHigh", "Other"))) %>%
  select(-n) %>%
  arrange(rtype, rtype, desc(perc)) 

perc %>% kable()


perc1 <- filter(perc, !(rtype %in% c("Local", "Other"))) %>%
  mutate(rtype = as.character(rtype),
         rtype = ifelse(rtype != "LocalConn", "high", rtype)) %>%
  pivot_wider(names_from = "rtype", values_from = "perc") 
filter(perc1, is.na(LocalConn) | is.na(high)) %>% dim()

roadtype1 <- ggplot(perc, aes(x= rtype, y = fct_inorder(ID), fill= perc)) + 
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red", name = "Percent") +
  xlab("") + ylab("Participant") +
  theme(text = element_text(size=12), axis.text.y = element_blank())
roadtype1

roadtype1 <- list(roadtype1, perc)
```


```{r}
rcomm1 <- mutate(rcomm, id2 = fct_reorder(id2, timemin)) %>%
  arrange(id2) %>%
  group_by(id2) %>%
  mutate(mean1 = mean(lPM, na.rm = T), lPM2 = lPM - mean1) %>%
  ungroup()
roadtype2 <- ggplot(rcomm1, aes(x = timemin, y = id2, fill = rtype)) +
  geom_tile() + ylab("Trip") + xlab("Minutes since trip start") +
  scale_fill_colorblind(name = "Road type") +
  theme_bw() +
  theme(text = element_text(size=12), axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position  = c(.75, .25))

pmtile <- ggplot(rcomm1, aes(x = timemin, y = id2, fill = lPM2)) +
  geom_tile() + ylab("Trip") + xlab("Minutes since trip start") +
  scale_fill_gradient(name = "log PM2.5 difference", low = "#FFFF33", high = "#FF3333") +
  theme_bw() +
  theme(text = element_text(size=12), axis.text.y = element_blank(),
        axis.ticks.y = element_blank(), legend.position = c(.75, .25))


pmtile
tripplot <- roadtype2 + pmtile
tripplot[[2]] = tripplot[[2]] + theme(axis.text.y = element_blank(),
                                        axis.ticks.y = element_blank(),
                                        axis.title.y = element_blank() )

tripplot
tripplot <- list(tripplot, rcomm1)
```

Not much difference if take mode over commute type

```{r}

select(rcomm, ID, date_local, group, rtypeMode) %>% unique() %>%
  count(rtypeMode) %>% mutate(perc = 100 * n/sum(n), perc = round(perc, 1)) %>%
  kable()
```

## Roadiness

Reporting values is not so useful (standardized)
```{r}

s1 <- summarize(rcomm, mean = mean(srness), sd = sd(srness), min = min(srness), max= max(srness))

s1 %>%
  kable(digits = 2)
ggplot(rcomm, aes(x = srness)) + geom_histogram(bins = 20)



# by ID
g1 <- group_by(rcomm, ID) %>% summarize(mean = mean(srness), sd = sd(srness), min = min(srness), max = max(srness))  %>% ungroup()
g1 %>% kable(digits = 2)

```

# Weather

L1 variables: I created as 1 day lag

## Variables

<https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/readme.txt>

- PRCP = Precipitation (tenths of mm)
- SNOW = Snowfall (mm)
- TMAX = Maximum temperature (degrees C, original tenths of degrees C)
- TMIN = Minimum temperature (degrees C, original tenths of degrees C)
- AWND = Average daily wind speed (m/s, original tenths of meters per second)
- wdf2, wdf5 direction of fastest wind (2 vs. 5 minutes) (degrees)
- cat2, cat5 categorical direction of fastest wind (2 vs. 5 minutes)



## EDA




```{r}

weather1 <- dplyr::select(rcomm, date_local, ID, awnd : snowL1m, snowbin: prcpbinL1m) %>%
  unique() %>%
  dplyr::select( -contains("wdf")) 

weather <- weather1 %>%
  pivot_longer(-c("ID", "date_local")) %>%
  filter(!(name %in% c("fog", "icehailgl", "smoke", "windsnow", "wdf2", "wdf5",
                       "snowbin", "snowbinL1", "snowbinL1m",
                       "prcpbin", "prcpbinL1", "prcpbinL1m")  ))
  
group_by(weather, name) %>% summarize(mean = mean(value), sd = sd(value), 
                min= min(value), max = max(value)) %>%
  kable(digits = 2)

ggplot(weather, aes(x = value)) +geom_histogram(bins = 10) + 
  facet_wrap(~name, scales = "free")
```


*Snow and precipation: binary*

```{r}
select(weather1, date_local, ID, contains("snowbin"), contains("prcpbin"), -windsnow) %>%
  pivot_longer(-c("ID", "date_local")) %>%
  group_by(name) %>%
  count(value) %>% mutate(perc = round(100* n/sum(n), 1)) %>% kable()
```


### By observation 

```{r}
weather1b <- dplyr::select(rcomm, date_local, ID, group, awnd : snowL1m,snowbin: prcpbinL1m) %>%
  unique() %>%
  dplyr::select(-contains("wdf"))

weatherb <- weather1b %>%
  pivot_longer(-c("ID", "date_local")) %>%
  filter(!(name %in% c("fog", "icehailgl", "smoke", "windsnow", "wdf2", "wdf5",
                        "snowbin", "snowbinL1", "snowbinL1m",
                       "prcpbin", "prcpbinL1", "prcpbinL1m")))
  
group_by(weatherb, name) %>% summarize(mean = mean(value), sd = sd(value), 
                min= min(value), max = max(value)) %>%
  kable(digits = 2)

ggplot(weatherb, aes(x = value)) +geom_histogram(bins = 10) + 
  facet_wrap(~name, scales = "free")
```


*Snow and precipation: binary*

```{r}
select(weather1b, date_local, ID, group, contains("snowbin"), contains("prcpbin"), -windsnow) %>%
  pivot_longer(-c("ID", "group", "date_local")) %>%
  group_by(name) %>%
  count(value) %>% mutate(perc = round(100* n/sum(n), 1)) %>% kable()

```


### Wind direction

```{r}
winddir <- select(rcomm, ID, date_local, cat2sm, cat5sm, wdf2, wdf5) %>% unique()
ggplot(winddir, aes(x = cat5sm)) + geom_bar()
ggplot(winddir, aes(x = cat2sm)) + geom_bar()

```

- Wind dir: 5
```{r}
count(winddir, cat5sm) %>% mutate(perc = round(100 * n / sum(n), 1)) %>% kable()

```

```{r}
datdir <- rename(winddir, dir = wdf5)
plot.windrose(datdir)
```


- Wind dir: 2
```{r}
count(winddir, cat2sm) %>% mutate(perc = round(100 * n / sum(n), 1)) %>% kable()

```

```{r}
datdir <- rename(winddir, dir = wdf2)
plot.windrose(datdir)
```

# compare commutes

```{r, fig.height = 30}
rcomm1 <- mutate(rcomm, dt1 = lubridate::date(rdatetime), 
                dt2 =  lubridate::as_datetime(dt1),
                dt2= lubridate::force_tz(dt2, "America/New_York"),
                diff1 = rdatetime - dt2, diff1 = diff1 / 60 / 60) %>%
  group_by(ID) %>%
  mutate(mindate = min(dt1), maxdate = max(dt1), 
         day = ifelse(dt1 == mindate, "day1", 
                      ifelse(dt1 == maxdate, "maxd", "mid")))
ggplot(rcomm1, aes(x = diff1, y = date_local, fill = rtype)) +
  geom_tile() +
  facet_wrap(~ID, ncol = 1, scales = "free_y")
```

Possible multiple obs of same commute:

- GMU 1045
- GMU 1040
- GMU 1037
- GMU 1036
- GMU 1035
- GMU 1032
- GMU 1018
- GMU 1016
- GMU 1007
- GMU 1001



# Daily PM

```{r}
dates <- select(rcomm, date_local) %>% unique()
if(nrow(dates) != 38) {
  stop("Incorrect dates: fix rcomm dates here")
}

va24 <- left_join(dates, va24)

dailypm <- ggplot(va24, aes(x = date_local, y = daily)) +
  geom_point() +
  ylab((expression(paste("ambient daily PM"[2.5], " (", mu, "g/m"^3, ")")))) +
  xlab("Date") +
  theme_bw() +
  theme(text = element_text(size = 12))
dailypm

dailypm <- list(dailypm, va24)

summarize(va24, mean(daily), sd(daily), min(daily), max(daily))
```


# Participant characteristics


```{r}
part <- select(rcomm, ID) %>% unique()


```

```{r}
save(boxplot1, roadtype1, tripplot, dailypm, file = here("figures/eda-tabfig.RData"))
```
