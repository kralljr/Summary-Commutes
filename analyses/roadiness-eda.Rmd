---
title: 'Roadiness: EDA'
author: "Jenna Krall"
date: "1/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r}
# libraries
library(tidyverse)
library(knitr)
library(here)
library(ggthemes)
library(RColorBrewer)


source(here("rcode/windrose.R"))

```


```{r}
# load data
load(here("data/rcomm.RData"))
rcomm <- mutate(rcomm, lPM = log(PM + 0.01))
```


# PM

## Zeroes

```{r}
filter(rcomm, PM == 0) %>% count(ID) %>% filter(n > 0)
```

## Histogram of log(PM + 0.01) by ID


```{r, fig.height = 20}
ggplot(rcomm, aes(x = lPM)) + geom_histogram(bins = 15) + 
  facet_wrap(~ID, scales ="free", ncol = 3)

```

## Summarize

```{r}

group_by(rcomm, ID) %>% summarize(mean = mean(lPM), 
      sd = sd(lPM), min = min(lPM), max = max(lPM)) %>%
  kable(digits = 2)
```

## Violin plots

```{r}
ggplot(rcomm, aes(y = ID, x  = lPM)) + geom_violin()
```



## Box plots

```{r}
ggplot(rcomm, aes(y = ID, x  = lPM)) + geom_boxplot()
```


## Commute summaries

### Mean by commute

```{r}
sumdat <- group_by(rcomm, ID, date_local, group) %>%
  summarize(meanPM= mean(lPM), sdPM = sd(lPM))

cols <- brewer.pal(8, "Dark2")
cols <- rep(cols, 4)
ggplot(sumdat, aes(x = meanPM, y = ID, colour = ID)) +
  geom_point(alpha = 0.7) +
  scale_color_manual(values = cols, guide = "none") +
  theme_bw()
```

### SD by commute

```{r}
# 1 observation only
ggplot(sumdat, aes(x = sdPM, y = ID, colour = ID)) +
  geom_point(alpha = 0.7) +
  scale_color_manual(values = cols, guide = "none") +
  theme_bw()
```


# Roadiness/Road type

```{r}
perc <- group_by(rcomm, ID) %>%
  count(rtype) %>%
  mutate(perc = n / sum(n) * 100, perc = round(perc, 1)) %>%
  select(-n) %>%
  arrange(rtype, desc(perc))

ggplot(perc, aes(x= rtype, y = fct_inorder(ID), fill= perc)) + 
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red")
```


```{r, fig.height = 20, eval = F}
perc <- group_by(rcomm, id2) %>%
  count(rtype) %>%
  mutate(perc = n / sum(n) * 100, perc = round(perc, 1)) %>%
  select(-n) %>%
  arrange(id2)

ggplot(perc, aes(x= rtype, y = fct_inorder(id2), fill= perc)) + 
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red")
```


# Weather

L1 variables: I created as 1 day lag

## Variables

<https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/readme.txt>

- PRCP = Precipitation (tenths of mm)
- SNOW = Snowfall (mm)
- TMAX = Maximum temperature (tenths of degrees C)
- TMIN = Minimum temperature (tenths of degrees C)
- AWND = Average daily wind speed (tenths of meters per second)
- wdf2, wdf5 direction of fastest wind (2 vs. 5 minutes) (degrees)



## EDA
```{r}
weather <- dplyr::select(rcomm, ID, awnd : snowL1) %>%
  dplyr::select(-contains("L1")) %>%
  pivot_longer(-ID) %>%
  filter(!(name %in% c("fog", "icehailgl", "smoke", "windsnow", "wdf2", "wdf5")))
  
group_by(weather, name) %>% summarize(mean = mean(value), sd = sd(value), 
                min= min(value), max = max(value)) %>%
  kable(digits = 2)

ggplot(weather, aes(x = value)) +geom_histogram(bins = 10) + 
  facet_wrap(~name, scales = "free")
```


```{r}

# https://www7.ncdc.noaa.gov/climvis/help_wind.html

datdir <- mutate(rcomm, cat2 = case_when((wdf2 <= 11 | wdf2 >=349) ~ "N",
                                         (wdf2 >= 12 & wdf2 <= 33) ~ "NNE",
                 (wdf2 >= 34 & wdf2 <= 56) ~ "NE", 
# N = North (349 - 011 degrees)
# NNE = North-Northeast (012-033 degrees)
# NE = Northeast (034-056 degrees)

                  (wdf2  >= 57 & wdf2 <= 78) ~ "ENE",
                   (wdf2 >= 79 & wdf2  <= 101) ~ "E",
                    (wdf2 >= 102 & wdf2 <= 123) ~ "ESE",
                    (wdf2 >= 124 & wdf2 <= 146) ~ "SE",
                  (wdf2 >= 147 & wdf2 <= 168) ~ "SSE",
                  (wdf2 >= 169 & wdf2 <= 191) ~ "S",
# ENE = East-Northeast (057-078 degrees)
# E = East (079-101 degrees)
# ESE = East-Southeast (102-123 degrees)
# SE = Southeast (124-146 degrees)
# SSE = South-Southeast (147-168 degrees)
# S = South (169-191 degrees)

(wdf2 >= 192 & wdf2 <= 213) ~ "SSW",
(wdf2 >= 214 & wdf2 <= 236) ~ "SW",
(wdf2 >= 237 & wdf2 <= 258) ~ "WSW",
(wdf2 >= 259 & wdf2 <= 281) ~ "W",
(wdf2 >= 282 & wdf2 <= 303) ~ "WNW",
# SSW = South-Southwest (192-213 degrees)
# SW = Southwest (214-236 degrees)
# WSW = West-Southwest (237-258 degrees)
# W = West (259-281 degrees)
# WNW = West-Northwest (282-303 degrees)
(wdf2 >= 304 & wdf2 <= 326) ~ "NW",
(wdf2 >= 327 & wdf2 <= 348) ~ "NNW"),
# NW = Northwest (304-326 degrees)
# NNW = North-Northwest (327-348 degrees)
# VAR = Variable wind direction
# CLM = Calm winds (speed = 0 knots)
cat5 = case_when((wdf5 <= 11 | wdf5 >=349) ~ "N",
                                         (wdf5 >= 12 & wdf5 <= 33) ~ "NNE",
                 (wdf5 >= 34 & wdf5 <= 56) ~ "NE", 
# N = North (349 - 011 degrees)
# NNE = North-Northeast (012-033 degrees)
# NE = Northeast (034-056 degrees)

                  (wdf5  >= 57 & wdf5 <= 78) ~ "ENE",
                   (wdf5 >= 79 & wdf5  <= 101) ~ "E",
                    (wdf5 >= 102 & wdf5 <= 123) ~ "ESE",
                    (wdf5 >= 124 & wdf5 <= 146) ~ "SE",
                  (wdf5 >= 147 & wdf5 <= 168) ~ "SSE",
                  (wdf5 >= 169 & wdf5 <= 191) ~ "S",
# ENE = East-Northeast (057-078 degrees)
# E = East (079-101 degrees)
# ESE = East-Southeast (102-123 degrees)
# SE = Southeast (124-146 degrees)
# SSE = South-Southeast (147-168 degrees)
# S = South (169-191 degrees)

(wdf5 >= 192 & wdf5 <= 213) ~ "SSW",
(wdf5 >= 214 & wdf5 <= 236) ~ "SW",
(wdf5 >= 237 & wdf5 <= 258) ~ "WSW",
(wdf5 >= 259 & wdf5 <= 281) ~ "W",
(wdf5 >= 282 & wdf5 <= 303) ~ "WNW",
# SSW = South-Southwest (192-213 degrees)
# SW = Southwest (214-236 degrees)
# WSW = West-Southwest (237-258 degrees)
# W = West (259-281 degrees)
# WNW = West-Northwest (282-303 degrees)
(wdf5 >= 304 & wdf5 <= 326) ~ "NW",
(wdf5 >= 327 & wdf5 <= 348) ~ "NNW"))

count(datdir, cat2) %>% arrange(desc(n))
# NW + NNW + W
# S + SE + ESE
# NNE

```


```{r}
wind <- select(rcomm, wdf2, wdf5) %>% na.omit()

# find cutoffs
km1 <- kmeans(wind$wdf2, 4)
km1$centers

km1 <- kmeans(wind$wdf5, 4)
km1$centers


cut(rcomm$wdf5, breaks = 4) %>% levels()

breaks <- c(110, 190, 275)

plot.windrose(datdir)
```
