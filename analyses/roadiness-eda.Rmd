---
title: 'Roadiness: EDA'
author: "Jenna Krall"
date: "1/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r}
# libraries
library(tidyverse)
library(knitr)
library(here)
library(ggthemes)
library(RColorBrewer)

```


```{r}
# load data
load(here("data/rcomm.RData"))
rcomm <- mutate(rcomm, lPM = log(PM + 0.01))
```


# PM

## Zeroes

```{r}
filter(rcomm, PM == 0) %>% count(ID) %>% filter(n > 0)
```

## Histogram of log(PM + 0.01) by ID


```{r, fig.height = 20}
ggplot(rcomm, aes(x = lPM)) + geom_histogram(bins = 15) + 
  facet_wrap(~ID, scales ="free", ncol = 3)

```

## Summarize

```{r}

group_by(rcomm, ID) %>% summarize(mean = mean(lPM), 
      sd = sd(lPM), min = min(lPM), max = max(lPM)) %>%
  kable(digits = 2)
```

## Violin plots

```{r}
ggplot(rcomm, aes(y = ID, x  = lPM)) + geom_violin()
```



## Box plots

```{r}
ggplot(rcomm, aes(y = ID, x  = lPM)) + geom_boxplot()
```


## Commute summaries

### Mean by commute

```{r}
sumdat <- group_by(rcomm, ID, date_local, group) %>%
  summarize(meanPM= mean(lPM), sdPM = sd(lPM))

cols <- brewer.pal(8, "Dark2")
cols <- rep(cols, 4)
ggplot(sumdat, aes(x = meanPM, y = ID, colour = ID)) +
  geom_point(alpha = 0.7) +
  scale_color_manual(values = cols, guide = "none") +
  theme_bw()
```

### SD by commute

```{r}
# 1 observation only
ggplot(sumdat, aes(x = sdPM, y = ID, colour = ID)) +
  geom_point(alpha = 0.7) +
  scale_color_manual(values = cols, guide = "none") +
  theme_bw()
```


# Roadiness/Road type

```{r}
perc <- group_by(rcomm, ID) %>%
  count(rtype) %>%
  mutate(perc = n / sum(n) * 100, perc = round(perc, 1)) %>%
  select(-n) %>%
  arrange(rtype, desc(perc))

ggplot(perc, aes(x= rtype, y = fct_inorder(ID), fill= perc)) + 
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red")
```


```{r, fig.height = 20, eval = F}
perc <- group_by(rcomm, id2) %>%
  count(rtype) %>%
  mutate(perc = n / sum(n) * 100, perc = round(perc, 1)) %>%
  select(-n) %>%
  arrange(id2)

ggplot(perc, aes(x= rtype, y = fct_inorder(id2), fill= perc)) + 
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red")
```


# Weather

L1 variables: I created as 1 day lag

## Variables

<https://www1.ncdc.noaa.gov/pub/data/ghcn/daily/readme.txt>

- PRCP = Precipitation (tenths of mm)
- SNOW = Snowfall (mm)
- TMAX = Maximum temperature (tenths of degrees C)
- TMIN = Minimum temperature (tenths of degrees C)
- AWND = Average daily wind speed (tenths of meters per second)
- wdf2, wdf5 direction of fastest wind (2 vs. 5 minutes) (degrees)



## EDA
```{r}
weather <- dplyr::select(rcomm, ID, awnd : snowL1) %>%
  dplyr::select(-contains("L1")) %>%
  pivot_longer(-ID) %>%
  filter(!(name %in% c("fog", "icehailgl", "smoke", "windsnow", "wdf2", "wdf5")))
  
group_by(weather, name) %>% summarize(mean = mean(value), sd = sd(value), 
                min= min(value), max = max(value)) %>%
  kable(digits = 2)

ggplot(weather, aes(x = value)) +geom_histogram(bins = 10) + 
  facet_wrap(~name, scales = "free")
```


```{r}
wind <- select(rcomm, wdf2, wdf5) %>% na.omit()

hclust(wind$wdf2)
cut(rcomm$wdf5, breaks = 4) %>% levels()

breaks <- c(110, 190, 275)
```
